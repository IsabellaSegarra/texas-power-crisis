---
title: "Investigating the 2021 Texas Power Crisis"
subtitle: "EDS-223 Assignment 3"
author: "Isabella Segarra"
date: 10-19-2025
format: 
  pdf: default 
  html: default
theme: pandoc
execute: 
  warning: false
  message: false
---

# TITLE 

[ADD README SCREENSHOT]
![](filepath)

### Objective
In this project, I investigated....

## Environment Set-up 
```{r}
#| output: false
#| message: false

# Load relevant libraries
library(sf) # For vector data
library(stars) # For raster data
library(terra) # raster handling
library(tmap) # For static and interactive maps
library(here) # For importing data 
library(tidyverse) # For data cleaning
library(dplyr) # For filtering data 
library(paletteer) # For pretty colors 
library(testthat) # For efficient workflows 

```

## Data Import
The data I am using in this project includes data from NASA's Worldview for night light data, data for roads and houses from OpenStreetMap (OSM), and socieconomic data from the U.S. Census Bureau's American Community Survey. 

### Night lights data import
This raster data is from NASA's Worldview tool, distributed through NASA's Level-1 and Atmospheric Archive & Distribution System Distributed Active Archive Center (LAADS DAAC). It is a `.tif` file that contains 10x10 degree tiles. I will be importing four data files from the `VNP46A1` folder for night light data from the days surrounding the storm as stars. 
```{r}

# Import tile h08v05 from 2021-02-07
nl_h08v05_07 <- read_stars(here("data", "VNP46A1","VNP46A1.A2021038.h08v05.001.2021039064328.tif"))

# Import tile h08v06 from 2021-02-07
nl_h08v06_07 <- read_stars(here("data", "VNP46A1","VNP46A1.A2021038.h08v06.001.2021039064329.tif"))

# Import tile h08v05 from 2021-02-16
nl_h08v05_16 <- read_stars(here("data", "VNP46A1","VNP46A1.A2021047.h08v05.001.2021048091106.tif"))

# Import tile h08v06 from 2021-02-16
nl_h08v06_16 <- read_stars(here("data", "VNP46A1","VNP46A1.A2021047.h08v06.001.2021048091105.tif"))

```

### Roads data import
This vector data is from OSM, processed with the help of a third party site (CITE) to produce a shapefile of all Texas highways. This data contains 6,085 observations with 11 variables. 
```{r}
# Import roads data with SQL query to filter for only highways (use st_read)
roads <- read_sf(here("data", "gis_osm_roads_free_1.gpkg"), query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'")

```

### House data import
This vector data is also from OSM, processed with the helpf of a third party(CITE) to produce a shapefile of houses in the Houseton metropolitan area. This data contains 475941 observations with 6 variables. 
```{r}
# Import house data with SQL query to filter for selected building types (use st_read)
houses <- read_sf(here("data", "gis_osm_buildings_a_free_1.gpkg"), query = "SELECT * FROM gis_osm_buildings_a_free_1 WHERE (type IS NULL AND name IS NULL) OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')")

```

## Socieconomic data import
This data is from  U.S. Census Bureauâ€™s American Community Survey (CITE) 2019 census. This Geodatabase (gdb) data contains data for Texas with  5,365 observations and 16 variables.  
```{r}
# Import socioeconomic geometry layer
socioeco_geom <- read_sf(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS")

# Import socieconomic income layer 
socioeco_income <- read_sf(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "X19_INCOME")

# View layers with 'st_layers' (commented out for now)
#st_layers(here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))

```

## Data wranlging

### CRS Matching (Might need to change up in workflow)
In order to work with all datasets, I need to confirm that the Coordinate Refrence Systems (CRS) match. 

```{r}
# ......Check CRS of individual datasets......

# Create list of the datasets that have geometries
datasets <- list(houses, roads, socioeco_geom, nl_h08v05_07, nl_h08v06_07, nl_h08v05_16, nl_h08v06_16)

# Loop through each dataset and print its CRS

for (i in seq_along(datasets)) {
  epsg <- st_crs(datasets[[i]])$epsg
  print(epsg)
  if (epsg != 4326) {
    print ("Coordinate reference systems do NOT match")
  }
}

# MAKE IT PRINT WITH THE NAMES OF THE DATA 

```
Since the CRS of 'socioeco_geom' is inconsistent with the CRSs of the rest of the data, I will transform this data to match the rest of the data. 

```{r}
# ......Transform CRS of 'socioeco' ......

# I only need to use the CRS of one object to convert. Roads is easy to spell.  
socioeco_geom <- st_transform(socioeco_geom, crs = st_crs(roads))

# Check if CRSs matched
if(st_crs(socioeco_geom) == st_crs(roads)) {
  print("coordinate reference systems match")
} else{
  print("coordinate reference systems do NOT match")
} 

```
### Check for Invalid geometries
Check for invalid geometries in our three datasets (roads, houses, socieoeco_geom) that contain a geometry type (e.g, multiploygon). 
```{r}
#......Checking for invalid geometries......

# Create a dataset with only the data that contains geometries
datasets_geom = list(roads, houses, socioeco_geom)

# Check if there are invalid geometries 
for (i in seq_along(datasets_geom)) {
  which(!st_is_valid(datasets_geom[[i]]))
  print("There are NO invalid geometries")
}
```

### Merge tiles 
EXPLAIN
```{r}
#......Night light change ......

# Merge night light for 2021-02-07
nl_07 <- st_mosaic(nl_h08v05_07, nl_h08v06_07)

# Merge night light for 2021-02-16
nl_16 <- st_mosaic(nl_h08v05_16, nl_h08v06_16)

# Confirm class of tiles
print(class(nl_07))
print(class(nl_16))

# Clear up environment for efficiency 
rm(list = c("nl_h08v05_07", "nl_h08v06_07"))
rm(list = c("nl_h08v05_16", "nl_h08v06_16"))

```


## Maps 1 and 2: Night Lights 
In this section, I mapped the night lights for February 7th and 16th. 
```{r}
# Create bounding box for Houston area 
bbox_houston <- st_bbox(c(xmin = -96.5, xmax = -94.5, ymax = 30.5, ymin = 29),crs = st_crs(nl_07)) # Match CRS to night light data

# Crop Feb 7th night light data
nl_07_crop<- st_crop(nl_07, bbox_houston)

# Crop Feb 16th night light data
nl_16_crop<- st_crop(nl_16, bbox_houston)

# Verify that 'nl_07' and 'nl_16' were cropped to Houston area

if(ncell(nl_07) == nrow(nl_07_crop)) {
  warning("data did not crop!")
} else {
  print("data cropped!")
}

if(ncell(nl_16) == nrow(nl_16_crop)) {
  warning("data did not crop!")
} else {
  print("data cropped!")
}

# Clear up environment for efficiency (DO LATER!)
#rm(list = c(""))

```

```{r}
#......Mapping 2021-02-07......

plot(nl_07_crop)


tm_shape(nl_07_crop) + # Plot the cropped data 
  tm_raster(
    palette = gray.colors(10),   # add gray scale 
    style = "quantile",         # MESS around with styling
   col.legend = tm_legend(title = "Light Intensity (units)")) + 
  tm_title("Houston, Texas Night Lights 02-07-2021") +
  tm_title("SUBTITLE") +
  tm_layout(bg.color = "white")

  

```


```{r}
#......Mapping 2021-02-07......
plot(nl_16)

tm_shape(nl_16_crop) + # Plot the cropped data 
  tm_raster(
    palette = gray.colors(10),   # add gray scale 
    style = "quantile",         # MESS around with styling
   col.legend = tm_legend(title = "Light Intensity (units)")) + 
  tm_title("Houston, Texas Night Lights 02-16-2021") +
  tm_title("SUBTITLE") +
  tm_layout(bg.color = "white")
   

```


```{r}
#

# use st_crop or st_interscts to join

```

### Find blackouts 
Find blackout regions by defining that blackout regions more than 200 nW cm-2sr-1 experienced a blackout and those more than 200 nW cm-2sr-1 did not experience a blackout. 
```{r}
#......Vector difference mask ......

# Create conditional where TRUEs are regions that experienced a blackout 
blackout <- (nl_16 - nl_07) > 200

# Reassign FALSEs as NA
blackout[blackout == FALSE] <- NA

# Turn into vector object (DOUBLE CJHECK IF U NEED TO DO THIS) 
blackout <- st_as_sf(blackout)

# View your new vector dataframe 
#head(blackout)

# Check for invalid geometries
if (any(!st_is_valid(blackout))) {
  blackout <- st_make_valid(blackout)
} else if (nrow(blackout) == 0) {
  print("No geometries found.")
} else {
  print("All geometries valid!")
}


```

```{r}
#......Crop 'Blackout' mask to Houston area ......

# Crop your sf object to Houston bbox made earlier 
blackout <- st_crop(blackout, bbox_houston)

# Re-project to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area)
blackout <- st_transform(blackout, crs = "EPSG:3083")

# Test that CRS re-projected
test_that("Texas CRS", {
  expect_equal(st_crs(blackout)$epsg, 3083)
}) 
```

## Map 3: Changing in night light intensity
```{r}
plot(blackout)

tm_shape(blackout) +
  tm_polygons() +
  tm_title("Blackout Regions February 2021 Texas Power Crisis", fontface = "bold")+
  tm_title("source:NASA VIIRS", size = 0.5) +
  tm_layout(bg.color = "white") +
  tm_basemap("CartoDB.PositronNoLabels") +
  tm_compass() +
  tm_scalebar()




```

## Highways
In this section, I will exclude highways from the blackout mask.
```{r}
#......Create buffer of 200 meters ......

# The CRS of 'roads' needs to be transformed to the Texas CRS
roads <- st_transform(roads, crs = "EPSG:3083")

# Identify areas within 200 m of all highways
buffer <- st_buffer(roads, dist = 200) 

# Check for invalid geometries (MAKE INTO PRINT STATEMENTS)
which(!st_is_valid(buffer))

# Check that buffer is a polygon (MAKE INTO PRINT STATEMENTS)
st_geometry_type(buffer)

tm_shape(buffer) +
  tm_polygons()

```

```{r}
#......Combine original roads and buffer......
# use st_union to combine original roads and buffer 

#roads_buffer <- st_union(roads, buffer)

tm_shape(roads_buffer) +
  tm_polygons()

```

```{r}
#......Areas further than 200 m......

# find areas that experienced blackouts that are further than 200 m  
  # can use sst_disjoin and st_difference 

st_difference()

# use the output of st_union 

```


## Buildings
```{r}
# overlap with areas that are non-highway and experience blackout

    # can use st_intersection, st_within, st_contains (write more about your justificaiton for using some, ex:    st_intersection will consider homes on the edge, within and contains doe snot )

# get homes that experienced blackount 


```

## Combine layers of socieco
```{r}
# THIS STEP HAPPENS AFTER  FINIDNT HE HOMES 

# use the sociecon to know where home are 
# interest in census track and mean income 

# layer 1 (geoms) & layer 2 (income) 

# left join them on GEO ID (make sure same CRS) 
  # use st_within or st_interesects 

# data wranglign to summarize median income by census tract 

# to find those that are not expe blackouts, go back to joining them 

# make a column called 'experienced blackout' vs 'did not experience blackout'
```


